# crawl_reddit.py 요약

## 역할
- OAuth 토큰을 사용해 Reddit 서브레딧 `/new` 엔드포인트에서 최신 게시물과 댓글을 가져온다.
- 게시물 정보를 `RedditPost` 데이터클래스로 래핑해 후속 파이프라인이 재사용할 수 있도록 한다.
- 단독 실행 시 특정 서브레딧의 게시물 제목, 스코어를 간단히 출력해 동작을 점검할 수 있다.

## 핵심 흐름
1. `_get_access_token()`이 사용자 `.env`에 저장된 자격정보로 OAuth 토큰을 발급받고 캐시한다.
2. `fetch_reddit_posts()`가 `https://oauth.reddit.com/r/{sub}/new`에 인증 요청을 보내 게시물 JSON을 가져온다.
3. 응답 내 `data.children[].data` 노드를 순회하며 제목, 작성자, 업보트 수, 댓글 수 등을 추출한다.
4. `preview`, `media_metadata` 정보를 분석해 이미지 URL 목록을 수집하고, 비디오/갤러리 게시물을 구분할 수 있도록 메타데이터를 채운다.
5. 각 게시물은 `permalink.json`을 재요청해 최대 깊이 2단·50개의 댓글을 수집하고, 삭제/스코어 정보를 메타데이터에 포함한다.
6. `max_age_hours`가 지정된 경우 해당 시간보다 오래된 게시물은 건너뛴다.
7. `RedditPost` 인스턴스를 생성해 호출 측에 반환하고, 필요 시 여러 서브레딧을 순차적으로 처리할 수 있다.

## 외부 의존성
- `requests`: OAuth 토큰 발급과 API 호출.
- `requests.auth.HTTPBasicAuth`: 토큰 발급 시 Basic 인증 헤더 작성.

## 운영 시 유의 사항
- Reddit은 User-Agent가 없거나 토큰이 만료되면 401/429를 반환할 수 있으므로 토큰 캐시와 헤더를 유지해야 한다.
- `max_age_hours` 설정으로 테스트 환경에서 오래된 게시물은 자동으로 제외된다.
- `metadata.is_video` 값을 통해 비디오 게시물 여부를 상위 레이어가 판단할 수 있다.
- 갤러리/미디어 게시물은 `media_metadata`를 통해 여러 이미지가 반환되므로 URL 중복 제거 로직이 포함돼 있다.
- 댓글은 최대 50개까지만 수집하므로 필요 시 상위 레이어에서 추가 호출을 고려해야 한다.

## 확장 아이디어
- Hot/Top 등 다른 정렬 기준도 지원할 수 있도록 파라미터화.
- 댓글 수집 범위를 조절하거나, 더 많은 메타데이터(플레어, 사용자 태그 등)를 추가.
- 에러/속도 제한 정보를 메타데이터에 기록해 모니터링 지표로 활용.
